version: 0.1
component: command
timeoutInSeconds: 300
shell: bash
steps:
    - type: Command    
      name: "CI creation for Motando application initialization"
      command: |
          oci container-instances container-instance create \
              --compartment-id "$COMPARTMENT_OCID" \
              --availability-domain "$AVAILABILITY_DOMAIN" \
              --shape "CI.Standard.E4.Flex" \
              --shape-config '{"memoryInGBs": 2.0, "ocpus": 1.0}' \
              --vnics "[{\"isPublicIpAssigned\": false, \"subnetId\": \"$SUBNET_OCID\"}]" \
              --container-restart-policy "NEVER" \
              --display-name "gru_ci_motando-webapp-init" \
              --wait-for-state "SUCCEEDED" \
              --containers "[{                    
                    \"environmentVariables\": {
                        \"DEPLOYMENT_ENV\": \"$DEPLOYMENT_ENV\",
                        \"LOAD_SAMPLE_DATA\": \"$LOAD_SAMPLE_DATA\",
                        \"MYSQL_ADMIN_SECRET_OCID\": \"$MYSQL_ADMIN_SECRET_OCID\", 
                        \"MYSQL_WEBAPPL_DBNAME\": \"$MYSQL_WEBAPPL_DBNAME\", 
                        \"MYSQL_HOST\": \"$MYSQL_HOST\", 
                        \"MYSQL_WEBAPPL_USER\": \"$MYSQL_WEBAPPL_USER\", 
                        \"MYSQL_WEBAPPL_SECRET_OCID\": \"$MYSQL_WEBAPPL_SECRET_OCID\",
                        \"GITHUB_REPO_URL\": \"$GITHUB_REPO_URL\",
                        \"OCI_STATICFILES_BUCKET_NAME\": \"$BUCKET_STATICFILES\",
                        \"OCI_REGION_ID\": \"$REGION_ID\",
                        \"MOTANDO_ACCESS_KEY_SECRET_OCID\": \"$MOTANDO_ACCESS_KEY_SECRET_OCID\",
                        \"MOTANDO_SECRET_KEY_SECRET_OCID\": \"$MOTANDO_SECRET_KEY_SECRET_OCID\",
                        \"WEBAPP_OCI_LOG_ID\": \"$WEBAPP_OCI_LOG_ID\"
                    }, 
                    \"imageUrl\": \"$MOTANDOINIT_IMAGE_URL\"}]"
              