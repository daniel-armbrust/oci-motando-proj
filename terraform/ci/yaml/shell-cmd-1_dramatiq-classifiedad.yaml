version: 0.1
component: command
timeoutInSeconds: 300
shell: bash
steps:
    - type: Command    
      name: "CI #1 creation for Dramatiq Classifiedad application"
      command: |
          oci container-instances container-instance create \
              --compartment-id "$COMPARTMENT_OCID" \
              --availability-domain "$AVAILABILITY_DOMAIN" \
              --shape "CI.Standard.E4.Flex" \
              --shape-config '{"memoryInGBs": 2.0, "ocpus": 1.0}' \
              --vnics "[{\"isPublicIpAssigned\": false, \"subnetId\": \"$SUBNET_OCID\"}]" \
              --container-restart-policy "ALWAYS" \
              --display-name "gru_ci-1_dramatiq-classifiedad" \
              --wait-for-state "SUCCEEDED" \
              --containers "[{
                    \"environmentVariables\": {
                         \"APP_ENV\": \"$APP_ENV\",
                         \"MYSQL_USER\": \"$MYSQL_WEBAPPL_USER\",
                         \"MYSQL_WEBAPPL_SECRET_OCID\": \"$MYSQL_WEBAPPL_SECRET_OCID\",
                         \"MYSQL_HOST\": \"$MYSQL_HOST\",
                         \"MYSQL_DBNAME\": \"$MYSQL_WEBAPPL_DBNAME\",
                         \"WORKFLOW_OCI_LOG_ID\": \"$WORKFLOW_OCI_LOG_ID\",
                         \"OCI_REGION_ID\": \"$REGION_ID\",
                         \"REDIS_HOST\": \"$REDIS_HOST\",
                         \"OCI_BUCKET_MOTANDO_IMG\": \"$BUCKET_MOTANDO_IMG\",
                         \"OCI_BUCKET_MOTANDO_IMGTMP\": \"$BUCKET_MOTANDO_IMGTMP\"
                    }, 
                    \"imageUrl\": \"$IMAGE_URL\"}]"
    - type: Command    
      name: "CI #2 creation for Dramatiq Classifiedad application"
      command: |
          oci container-instances container-instance create \
              --compartment-id "$COMPARTMENT_OCID" \
              --availability-domain "$AVAILABILITY_DOMAIN" \
              --shape "CI.Standard.E4.Flex" \
              --shape-config '{"memoryInGBs": 2.0, "ocpus": 1.0}' \
              --vnics "[{\"isPublicIpAssigned\": false, \"subnetId\": \"$SUBNET_OCID\"}]" \
              --container-restart-policy "ALWAYS" \
              --display-name "gru_ci-2_dramatiq-classifiedad" \
              --wait-for-state "SUCCEEDED" \
              --containers "[{
                    \"environmentVariables\": {
                         \"APP_ENV\": \"$APP_ENV\",
                         \"MYSQL_USER\": \"$MYSQL_WEBAPPL_USER\",
                         \"MYSQL_WEBAPPL_SECRET_OCID\": \"$MYSQL_WEBAPPL_SECRET_OCID\",
                         \"MYSQL_HOST\": \"$MYSQL_HOST\",
                         \"MYSQL_DBNAME\": \"$MYSQL_WEBAPPL_DBNAME\",
                         \"WORKFLOW_OCI_LOG_ID\": \"$WORKFLOW_OCI_LOG_ID\",
                         \"OCI_REGION_ID\": \"$REGION_ID\",
                         \"REDIS_HOST\": \"$REDIS_HOST\",
                         \"OCI_BUCKET_MOTANDO_IMG\": \"$BUCKET_MOTANDO_IMG\",
                         \"OCI_BUCKET_MOTANDO_IMGTMP\": \"$BUCKET_MOTANDO_IMGTMP\"
                    }, 
                    \"imageUrl\": \"$IMAGE_URL\"}]"