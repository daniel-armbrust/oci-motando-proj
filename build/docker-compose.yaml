version: "3.4"
services:
    webapp:
        build:
            context: ../webapp/
            target: envdev        
        image: motando-webapp:latest
        restart: unless-stopped
        environment:
            APP_ENV: "DEV"
            OCI_REGION_ID: "sa-saopaulo-1"
            OCI_OBJSTR_NAMESPACE: ${OCI_OBJSTR_NAMESPACE}
            OCI_STATICFILES_BUCKET_NAME: "motando-staticfiles"
            OCI_BUCKET_MOTANDO_IMGTMP: "motando-tmpimg"
            OCI_BUCKET_MOTANDO_IMG: "motando-img"
            OCI_ACCESS_KEY_ID: ${OCI_ACCESS_KEY_ID}
            OCI_SECRET_ACCESS_KEY: ${OCI_SECRET_ACCESS_KEY}
            MYSQL_HOST: "${MYSQL_HOST}"
            MYSQL_USER: "${APPDB_USER}"
            MYSQL_PASSWD: "${APPDB_PASSWD}"
            MYSQL_DBNAME: "motandodb"
            OCI_LOG_ID: "${WEBAPP_LOG_ID}"
            CLASSIFIEDAD_TASK_QUEUE_HOST: "${CLASSIFIEDAD_TASK_QUEUE_HOST}"
            CLASSIFIEDAD_TASK_QUEUE_PORT: "${CLASSIFIEDAD_TASK_QUEUE_PORT}"
        depends_on:
            - celery-classifiedad        
        ports:
            - 8000:8000
        network_mode: "host"
    rabbitmq:
        image: rabbitmq:3.12-management
        restart: unless-stopped
        environment:
            RABBITMQ_DEFAULT_VHOST: "motando-vhost"        
        ports:            
            - 15672:15672
            - 5555:5555
            - 5672:5672
        network_mode: "host"
    celery-classifiedad:
        build:
            context: ../services/celery-classifiedad/
            target: envdev
        image: celery-classifiedad:latest
        restart: unless-stopped
        environment:
            APP_ENV: "DEV"
            RESULTDB_HOST: "${MYSQL_HOST}"
            RESULTDB_USER: "${RESULTDB_USER}"
            RESULTDB_PASSWD: "${RESULTDB_PASSWD}"
            RESULTDB_DBNAME: "celeryresultdb"
            APPDB_HOST: "${MYSQL_HOST}"
            APPDB_USER: "${APPDB_USER}"
            APPDB_PASSWD: "${APPDB_PASSWD}"
            APPDB_DBNAME: "motandodb"
            BROKER_HOST: "${BROKER_HOST}"
            BROKER_USER: "${BROKER_USER}"
            BROKER_PASSWD: "${BROKER_PASSWD}"
            BROKER_VHOST: "motando-vhost"
            OCI_LOG_ID: "${BROKER_LOG_ID}"
            OCI_REGION_ID: "sa-saopaulo-1"
            OCI_OBJSTR_NAMESPACE: "${OCI_OBJSTR_NAMESPACE}"
            OCI_BUCKET_MOTANDO_IMGTMP: "motando-tmpimg"
            OCI_BUCKET_MOTANDO_IMG: "motando-img"
        depends_on:
            - rabbitmq
        expose:
            - "8100"        
        network_mode: "host"